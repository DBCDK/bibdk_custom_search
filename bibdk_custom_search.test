<?php
/**
* Tests the functionality of bibdk custom search.
*/

class BibdkCustomSearchTestCase extends DrupalWebTestCase {
  protected $privileged_user;

  private function append_file($content) {
    $name = '/data/www/jgn.ding/sites/default/files/jgn.log';
    $fp = fopen($name, 'a');
    if ( $fp ) {
      if ( fwrite($fp, print_r($content,1) . "\n\n") ) {
        fclose($fp);
      } else return false;
    } else return false;
    return true;
  }

  public static function getInfo() {
    return array(
      'name' => 'Bibdk Custom Search',
      'description' => 'Bibdk Custom Search test.',
      'group' => 'bibliotek.dk',
    );
  }

  public function setUp() {
    $this->profile = 'minimal';
    parent::setUp('bibdk_custom_search', 'search', 'uuid');
    menu_rebuild();
  }


  public function testRunner(){
    // Create and log in our privileged user.
    $this->privileged_user = $this->drupalCreateUser(array(
      'administer bibdk custom search pages',
      'administer search',
      'administer blocks',
      'search content',
      ));
    $this->drupalLogin($this->privileged_user);
    $this->_testParseFormFunction();
    $this->_testBibdkCustomSearchCreatePage();

    return true;

  }

  private function _testParseFormFunction(){
    $elements = array(
      '81335603-ae1d-5de4-25c7-a1538e7ad8f5' => array(
        'element_label' => 'Forfatter',
        'description' => 'fx nesbo',
        'help_text' => 'Sog forfatter:
Skriv den eller de dele af navnet, du er sikker paa. Kombiner evt. med et ord fra titlen - det skal skrives i titelboksen.',
        'region' => 'main',
        'access_key' => 'f',
        'tab_index' => '0',
        'values' => array(
          '1150ebb6-8e38-27d4-b929-840f71d17137' => array(
            'value_title' => 'ophav',
            'value_type' => 'textfield',
            'search_code' => 'dkcclterm.fo',
            'default_value' => '',
            'options' => array(
              'nnj' => array(
                'label' => 'fjhfjhgfjh',
                'v_uuid' => '1150ebb6-8e38-27d4-b929-840f71d17137',
              )
            )
          )
        )
      )
    );

    $page = array(
      'pid' => '5',
      'p_uuid' => 'd3099a71-b1b6-f5c4-4170-6b8593ad446b',
      'page_title' => 'Alle materialer',
      'page_path' => 'bibdk_frontpage',
      'menu_title' => 'Alle materialer',
      'delimiter' => null,
      'expand' => '1',
      'sort' => '-10',
    );

    $expected_result = array (
      'bibdk_custom_search_element_81335603-ae1d-5de4-25c7-a1538e7ad8f5' =>
      array (
        '#type' => 'fieldset',
        '#collapsible' => false,
        '#collapsed' => false,
        '#tree' => true,
        '#region' => 'main',
        '#theme' => 'bibdk_search_element',
        '#title_text' => 'Forfatter',
        '#description_text' => 'fx nesbo',
        '#help_text' => 'Sog forfatter:
Skriv den eller de dele af navnet, du er sikker paa. Kombiner evt. med et ord fra titlen - det skal skrives i titelboksen.',
        '#attributes' =>
        array (
          'class' =>
          array (
            0 => 'forfatter',
            1 => 'element-wrapper',
          ),
        ),
        '1150ebb6-8e38-27d4-b929-840f71d17137' =>
        array (
          '#type' => 'textfield',
          '#title' => 'ophav',
          '#title_display' => 'invisible',
          '#default_value' => '',
          '#disabled'      => 0,
          '#attributes' =>
          array (
            'tabindex' =>
            array (
              0 => '0',
            ),
            'accesskey' =>
            array (
              0 => 'f',
            ),
            'term' =>
            array (
              0 => '1150ebb6-8e38-27d4-b929-840f71d17137',
            ),
          ),
          '#tree' => false,
          '#size' => 30,
          '#maxlength' => 64,
        ),
      ),
      '#collapsed' => '1',
      '#main_search_name' => 'Alle materialer',
    );

    $result = _bibdk_custom_search_advanced_fields_parse_form($elements, $page);

    // log
    // $this->append_file($result);
    // $this->append_file($expected_result);

    $this->assertEqual($result, $expected_result, 'Render array correctly parsed');
  }

  private function _testBibdkCustomSearchCreatePage() {

    // Test creation of a custom search page.
    $edit = array();
    $page_title = $edit['bibdk_custom_search[0][page_title]'] = $this->randomName(8);
    $this->drupalPost('admin/config/search/bibdk_custom_search', $edit, t('Save'));
    $this->assertText(
      t('The page "@page" have been created.', array('@page' => $edit['bibdk_custom_search[0][page_title]']))
    );

    // Test creation of a custom search element.
    $edit = array();
    $element_title = $edit['bibdk_custom_search_page_elements[0][element_title]'] = $this->randomName(8);
    $this->drupalPost('admin/config/search/bibdk_custom_search/elements', $edit, t('Save'));
    $this->assertText(
      t('The element "@element" have been created.', array('@element' => $edit['bibdk_custom_search_page_elements[0][element_title]']))
    );

    // Test creation of a custom search value.
    $edit = array();
    $value_title = $edit['bibdk_custom_search[0][value_title]'] = $this->randomName(8);
    $this->drupalPost('admin/config/search/bibdk_custom_search/values', $edit, t('Save'));
    $this->assertText(
      t('The value "@value" have been created.', array('@value' => $edit['bibdk_custom_search[0][value_title]']))
    );

    // Test editing a custom search value.
    //$this->drupalPost('admin/config/search/bibdk_custom_search/values', null, t('edit'));
    $this->clickLink('edit');
    $edit = array();
    $edit['element_value[value_type]'] = 'textfield';
    $edit['element_value[search_code]'] = $this->randomName(8);
    $this->drupalPost(NULL, $edit, t('Save'));
    $this->assertFieldByName(
      'element_value[value_type]',
      $edit['element_value[value_type]'],
      t('The value "@value_title" have been set to a type "@type".', array('@value_title' => $value_title, '@type'=>$edit['element_value[value_type]']))
    );
    $this->assertFieldByName(
      'element_value[search_code]',
      $edit['element_value[search_code]'],
      t('The value "@value_title" have been assigned a search code "@code".', array('@value_title' => $value_title, '@code'=>$edit['element_value[search_code]']))
    );

    // Test editing a custom search element.
    $value = db_select('bibdk_custom_search_elements', 't')->fields('t', array('e_uuid'))->condition('eid', 1, '=')->execute()->fetchAssoc();
    $e_uuid = $value['e_uuid'];

    $this->drupalGet('admin/config/search/bibdk_custom_search/elements');

    $this->clickLink('edit');
    $edit = array();
    $element_label = $edit['bibdk_custom_search_page_element[element_label]'] = $this->randomName(8);
    $edit['bibdk_custom_search_page_element[access_key]'] = $this->randomName(1);
    $edit['bibdk_custom_search_page_element[tab_index]'] = rand(0, 100);
    $element_description = $edit['bibdk_custom_search_page_element[description]'] = $this->randomName(40);
    $edit['bibdk_custom_search_page_element[help_text]'] = $this->randomName(10);
    $this->drupalPost(null, $edit, t('Save'));
    $this->assertFieldByName(
      'bibdk_custom_search_page_element[element_label]',
      $edit['bibdk_custom_search_page_element[element_label]'],
      t('The element "@element_title" have been assigned a label "@val".', array('@element_title' => $element_title, '@val'=>$edit['bibdk_custom_search_page_element[element_label]']))
    );
    $this->assertFieldByName(
      'bibdk_custom_search_page_element[access_key]',
      $edit['bibdk_custom_search_page_element[access_key]'],
      t('The element "@element_title" have been assigned an accesskey "@val".', array('@element_title' => $element_title, '@val'=>$edit['bibdk_custom_search_page_element[access_key]']))
    );
    $this->assertFieldByName(
      'bibdk_custom_search_page_element[tab_index]',
      $edit['bibdk_custom_search_page_element[tab_index]'],
      t('The element "@element_title" have been assigned a tabindex "@val".', array('@element_title' => $element_title, '@val'=>$edit['bibdk_custom_search_page_element[tab_index]']))
    );
    $this->assertFieldByName(
      'bibdk_custom_search_page_element[description]',
      $edit['bibdk_custom_search_page_element[description]'],
      t('The element "@element_title" have been assigned a description "@val".', array('@element_title' => $element_title, '@val'=>substr($edit['bibdk_custom_search_page_element[description]'],0,40) . '[...]'))
    );
    $this->assertFieldByName(
      'bibdk_custom_search_page_element[help_text]',
      $edit['bibdk_custom_search_page_element[help_text]'],
      t('The element "@element_title" have been assigned a helptext "@val".', array('@element_title' => $element_title, '@val'=>substr($edit['bibdk_custom_search_page_element[help_text]'],0,40) . '[...]'))
    );

    // Test adding a value to a custom search element.
    $value = db_select('bibdk_custom_search_values', 'v')->fields('v', array('v_uuid'))->condition('vid', 1, '=')->execute()->fetchAssoc();
    $v_uuid = $value['v_uuid'];
    $edit = array();
    $edit['bibdk_custom_search_page_element_values[0][v_uuid]'] = $v_uuid;
    //$this->drupalPost(null, $edit, t('Save'));
    $this->drupalPost('admin/config/search/bibdk_custom_search/elements/' . $e_uuid . '/edit', $edit, t('Save'));
    $this->assertText($value_title, t('The value "@value_title" was found.', array('@value_title' => $value_title)));
    $this->assertLinkByHref(
      'admin/config/search/bibdk_custom_search/values/' . $v_uuid . '/edit'
    );
    $value = db_select('bibdk_custom_search_map_values', 'v')->fields('v', array('mv_uuid'))->condition('mid', 1, '=')->execute()->fetchAssoc();
    $mv_uuid = $value['mv_uuid'];

    $this->assertLinkByHref(
      'admin/config/search/bibdk_custom_search/elements/' . $e_uuid . '/remove_value/' . $mv_uuid
    );

    // Test editing a custom search page.
    $value = db_select('bibdk_custom_search', 't')->fields('t', array('p_uuid'))->condition('pid', 1, '=')->execute()->fetchAssoc();
    $p_uuid = $value['p_uuid'];

    $edit = array();
    $frontpage = variable_get('site_frontpage', 'node');
    $page_menu_title = $edit['page[menu_title]'] = $this->randomName(8);
    $page_path = $edit['page[page_path]'] = $frontpage;
    $this->drupalPost('admin/config/search/bibdk_custom_search/' . $p_uuid . '/edit', $edit, t('Save'));
    $this->assertFieldByName(
      'page[menu_title]',
      $edit['page[menu_title]'],
      t('The page "@page_title" have been assigned a menu title "@val".', array('@page_title' => $page_title, '@val'=>$edit['page[menu_title]']))
    );
    $this->assertFieldByName(
      'page[page_path]',
      $edit['page[page_path]'],
      t('The page "@page_title" have been assigned a path "@val".', array('@page_title' => $page_title, '@val'=>$edit['page[page_path]']))
    );

    // Test adding an element to a custom search page.
    $value = db_select('bibdk_custom_search_map_elements', 't')->fields('t', array('me_uuid'))->condition('mid', 1, '=')->execute()->fetchAssoc();
    $me_uuid = $value['me_uuid'];
    $edit = array();
    $edit['elements[0][e_uuid]'] = $e_uuid;
    $edit['elements[0][region]'] = 'main';
    $this->drupalPost('admin/config/search/bibdk_custom_search/' . $p_uuid . '/edit', $edit, t('Save'));
    $this->assertText($element_title);
    $this->assertLinkByHref(
      'admin/config/search/bibdk_custom_search/elements/' . $e_uuid . '/edit'
    );
    $this->assertLinkByHref(
      'admin/config/search/bibdk_custom_search/' . $p_uuid . '/remove_element/' . $me_uuid
    );

    // Test a custom search page form.
    $this->drupalGet($page_path);
    $this->assertFieldByName(
      'search_block_form'
    );
    $this->assertText($element_label,t('The element label "@element_label" was found',array('@element_label'=>$element_label)));
    $this->assertText($element_description,t('The element description "@element_description" was found',array('@element_description'=>substr($element_description,0,40) . '[...]')));
    $this->assertFieldByName($v_uuid);
    $this->assertNoPattern('/<form .*<form .*<\/form/sm', t('No nested forms found.'));



    // Test setting a custom search value to 'disabled'.
    $this->drupalGet('admin/config/search/bibdk_custom_search/values');
    $this->clickLink('edit'); // there's only one value made
    $edit = array();
    $edit['element_value[is_disabled]'] = 1;

    $this->drupalPost(NULL, $edit, t('Save'));

    $this->assertFieldChecked('edit-element-value-is-disabled', t('The value "@value_title" have been set to "disabled".', array('@value_title' => $value_title) ));

    $this->drupalGet($page_path);
    $this->assertFieldByName(
      'search_block_form'
    );
    $disabled_field = $this->xpath('//input[@id=:id and @disabled="disabled"]', array(':id' => 'edit-' . $v_uuid));
    $this->assertTrue($disabled_field, t('The value "@value_title" was set to "disabled"',array('@value_title'=>$value_title)));


    // Test setting a custom search element to 'disabled'.
    $this->drupalGet('admin/config/search/bibdk_custom_search/elements');
    $this->clickLink('edit'); // there's only one element made
    $edit = array();
    $edit['bibdk_custom_search_page_element[is_disabled]'] = 1;

    $this->drupalPost(null, $edit, t('Save'));

    $this->assertFieldChecked('edit-bibdk-custom-search-page-element-is-disabled', t('The value "@value_title" have been set to "disabled".', array('@value_title' => $value_title) ));

    $this->drupalGet($page_path);
    $this->assertFieldByName(
      'search_block_form'
    );
    $this->assertNoField($v_uuid, t('The disabled element "@element_label" was removed from the form',array('@element_label'=>$element_label)));


    // Test setting a custom search page to 'disabled'.
    $this->drupalGet('');
    $this->assertFieldByName('search_block_form');
    $this->assertLink($page_menu_title, 0, t('The page "@page_menu_title" is present in the menu.',array('@page_menu_title'=>$page_menu_title)));

    $this->drupalGet('admin/config/search/bibdk_custom_search');
    $this->clickLink('edit'); // there's only one page made
    $edit = array();
    $edit['page[is_disabled]'] = 1;

    $this->drupalPost(null, $edit, t('Save'));

    $this->assertFieldChecked('edit-page-is-disabled', t('The page "@page_title" have been set to "disabled".', array('@page_title' => $page_title) ));

    $this->drupalGet('');
    $this->assertFieldByName('search_block_form');
    $this->assertNoLink($page_menu_title, t('The disabled page "@page_menu_title" was removed from the menu.',array('@page_menu_title'=>$page_menu_title)));

  }

}
