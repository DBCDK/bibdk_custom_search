<?php

/**
 * @file
 * Bring customizations to the default search box
 */

/*
 *  TO DO (optionally): wildcard matching on search page path?
 */
module_load_include('inc', 'bibdk_custom_search', 'bibdk_custom_search.export');
module_load_include('inc', 'bibdk_custom_search', 'bibdk_custom_search.list');
module_load_include('inc', 'bibdk_custom_search', 'bibdk_custom_search.db_queries');
module_load_include('inc', 'bibdk_custom_search', 'bibdk_custom_search.advanced_form');


/**
 * Implements hook_menu().
 */
function bibdk_custom_search_menu() {
  $items['testing'] = array(
    'title' => 'Custom searchpage AJAX callback',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_form'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'bibdk_custom_search.list.inc'
  );
  $items['frontpage/searchpage_callback'] = array(
    'title' => 'Custom searchpage AJAX callback',
    'page callback' => 'bibdk_custom_searchpage_ajax_callback',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['admin/config/search/bibdk_custom_search'] = array(
    'title' => 'bibdk search pages',
    'description' => 'Customize the default search, add custom search pages, and change labels, values & ordering.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_admin'),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.pages.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/settings'] = array(
    'title' => 'Pages',
    'description' => 'Create, alter or delete search pages.',
    'access arguments' => array('administer bibdk custom search pages'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  );
  $items['admin/config/search/bibdk_custom_search/%/edit'] = array(
    'title' => 'Edit search page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_page_edit', 4),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.pages.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/%/remove_element/%'] = array(
    'title' => 'Edit search page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_page_edit', 4, 6),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.pages.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/%/delete'] = array(
    'title' => 'Edit search page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_delete_page', 4),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.pages.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/elements'] = array(
    'title' => 'Elements',
    'description' => 'Create, alter or delete search options in the search block.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_elements_admin'),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.elements.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );
  $items['admin/config/search/bibdk_custom_search/elements/%/edit'] = array(
    'title' => 'Edit search element',
    'description' => 'Edit and add values to a search element.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_element_edit', 5),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.elements.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/elements/%/remove_value/%'] = array(
    'title' => 'Edit search element',
    'description' => 'Edit and add values to a search element.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_element_edit', 5, 7),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.elements.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/elements/%/delete'] = array(
    'title' => 'Delete search element',
    'description' => 'Delete a search element.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_element_delete', 5),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.elements.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/values'] = array(
    'title' => 'Values',
    'description' => 'Create, alter or delete search element values.',
    'page arguments' => array('bibdk_custom_search_values_admin'),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.values.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 4,
  );
  $items['admin/config/search/bibdk_custom_search/values/%/edit'] = array(
    'title' => 'Edit search value',
    'description' => 'Edit and add values to a search value.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_value_edit', 5),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.values.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/values/%/delete'] = array(
    'title' => 'Delete search value',
    'description' => 'Delete a search value.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_value_delete', 5),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.values.admin.inc',
  );
  $items['admin/config/search/bibdk_custom_search/values/%/delete_option/%'] = array(
    'title' => 'Delete search value',
    'description' => 'Delete a search value.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_custom_search_value_edit', 5, 7),
    'access arguments' => array('administer bibdk custom search pages'),
    'file' => 'includes/bibdk_custom_search.values.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_help().
 */
function bibdk_custom_search_help($path, $arg) {
  switch ($path) {
    case 'admin/help#bibdk_custom_search';
    case 'admin/config/search/bibdk_custom_search/values';
      $file = drupal_get_path('module', 'bibdk_custom_search') . "/help/bibdk_custom_search.html";
      return $output = file_get_contents($file);
      break;
  }
}


/**
 * Implements hook_permission().
 */
function bibdk_custom_search_permission() {
  return array(
    'administer bibdk custom search pages' => array(
      'title' => t('Administer custom search pages'),
      'description' => t('Allow users to create and edit custom search pages.'),
    ),
  );
}


/**
 * Implements hook_form_FORM_ID_alter() for form search_block_form.
 */
function bibdk_custom_search_form_search_block_form_alter(&$form, &$form_state, $form_id) {

  $page_id = (isset($_GET['page_id'])) ? $_GET['page_id'] : ((isset($_GET['q'])) ? $_GET['q'] : NULL);

  $default_value = (isset($_GET['req'])) ? $_GET['req'] : $form['search_block_form']['#default_value'];

  $form['search_block_form']['#default_value'] = $default_value;

  $form['search_block_form']['#attributes']['placeholder'] = t('placeholder_text', array(), array('context' => 'bibdk_custom_search'));

  $form['#attributes']['data-type'] = array($page_id);

  $form['page_id'] = array(
    '#type' => 'hidden',
    '#title' => t('Page ID'),
    '#title_display' => 'invisible',
    '#default_value' => $page_id,
  );


  /**
   * Gets the searchpages navigationbar if pages exists
   */
  if ($searchpages = _bibdk_custom_search_get_searchpage_buttons($page_id)) {
    $form['searchpages'] = $searchpages;
  }


  /**
   * Gets the advances search fields if they exists
   */
  if ($advanced_fields = _bibdk_custom_search_get_advanced_fields_form($page_id)) {

    $form['advanced'] = $advanced_fields;
  }


  $form['#attached']['css'][] = drupal_get_path('module', 'bibdk_custom_search') . '/css/bibdk_custom_search.css';
  $form['#attached']['js'][] = drupal_get_path('module', 'bibdk_custom_search') . '/js/bibdk_custom_search_options_subgroup.js';
  $form['#submit'] = array('bibdk_custom_search_submit');

  return $form;
}

/**
 * get form for advanced search fields
 */
function _bibdk_custom_search_get_advanced_fields_form($destination = FALSE) {

  // get search page
  $page = _bibdk_custom_search_get_page_db($destination);
  if (empty($page)) {
    return NULL;
  }

  // Get results form db
  $result = _bibdk_custom_search_get_advanced_fields_db($page);
  if (empty($result)) {
    return NULL;
  }

  // Get default values
  $default_values = isset($_GET['qe']) ? $_GET['qe'] : array();

  // Move elements with no search code to top level of default values array
  if (isset($default_values['n/a'])) {
    $default_values += $default_values['n/a'];
    unset($default_values['n/a']);
  }

  $form = array(
    '#type' => 'fieldset',
    '#theme' => 'bibdk_custom_advanced_search_menu',
    '#visuallyhidden' => _bibdk_custom_search_is_advanced_search_expanded($_GET),
    '#attributes' => array(
      'class' => array(_bibdk_custom_search_trim_string(($page['page_title']) ? $page['page_title'] : FALSE),
      ),
      'data-type' => array($_GET['q']),
    ),
  );

  $form += _bibdk_custom_search_create_advanced_form($result, $page, $default_values);

  // Page specific elements
  if ($page['delimiter']) {
    $form['delimiter'] = array(
      '#type' => 'hidden',
      '#region' => 'main',
      '#value' => $page['delimiter'],
    );
  }

  $form['#custom_submit'] = array(
    '#type' => 'submit',
    '#value' => t('custom_search', array(), array('context' => 'bibdk_custom_search')),
    '#region' => 'main',
    '#executes_submit_callback' => TRUE,
    '#attributes' => array(
      'class' => array(
        'btn-submit'
      ),
    ),
  );

  $form['#collapsed'] = ($page['expand']) ? $page['expand'] : FALSE;
  $form['#main_search_name'] = ($page['page_title']) ? $page['page_title'] : FALSE;

  return $form;
}


/**
 * Process a block search form submission.
 **/
function bibdk_custom_search_submit($form, &$form_state) {
  // The search form relies on control of the redirect destination for its
  // functionality, so we override any static destination set in the request,
  // for example by drupal_access_denied() or drupal_not_found()
  // (see http://drupal.org/node/292565).
  if (isset($_GET['destination'])) {
    unset($_GET['destination']);
  }

  $form_id = $form['form_id']['#value'];
  $keys = $form_state['values'][$form_id];

  form_state_values_clean($form_state);

  $q = array();
  if (!empty($keys)) {
    $q[] = $keys;
  }

  $extended_fields = _bibdk_custom_search_get_field_searchcodes();
  $extended = array();

  foreach ($form_state['values'] as $_key => $values) {
    $key = str_replace('_', '.', $_key);
    $no_searchcode = preg_match('@n/a@', $key);
    if (!isset($extended_fields[$key]['search_code']) && !$no_searchcode) {
      continue;
    }
    if (!is_array($values)) {
      $values = array($values);
    }
    foreach ($values as $value) {

      if ($value) {
        if ($no_searchcode) {
          $extended['qe']['n/a'][$key][] = _translate_boolean($value);
        }
        else {
          $extended['qe'][$key][] = _translate_boolean($value);
        }

      }
    }
  }

  // Check to see if the form was submitted empty.
  // If it is empty, display an error message.
  // (This method is used instead of setting #required to TRUE for this field
  // because that results in a confusing error message.  It would say a plain
  // "field is required" because the search keywords field has no title.
  // The error message would also complain about a missing #title field.)
  if (sizeof($q) == 0 && sizeof($extended) == 0) {
    form_set_error('keys', t('Please enter some keywords.', array(), array('context' => 'bibdk_custom_search:error')));
    return FALSE;
  }

  if (isset($form_state['values']['delimiter']) && $delimiter = $form_state['values']['delimiter']) {
    $extended['qe']['delimiter'] = $delimiter;
  }

  if (isset($form_state['values']['page_id'])) {
    $extended['page_id'] = $form_state['values']['page_id'];
  }

  $op = _bibdk_custom_search_get_cql('AND');
  $q = join($op, $q);

  $controls = module_invoke_all('ting_search_get_controls', $form, $form_state);

  $query = $controls + $extended;

  $search_info = array();
  $request_path = arg();

  if ($request_path[0] != 'search' || !isset($request_path[1])) {
    $search_info = search_get_default_module_info();
  }
  else {
    foreach (search_get_info() as $search_engine) {
      if ($search_engine['path'] == $request_path[1]) {
        $search_info = $search_engine;
        break;
      }
    }
  }
  if (!empty($search_info['path']) && in_array($search_info['module'], variable_get('search_active_modules', array()))) {
    $url = 'search/' . $search_info['path'] . '/' . trim($q);
    drupal_goto($url, array('query' => $query, 'fragment' => 'content'));

  }
  else {
    form_set_error('keys', t('Search is currently disabled.', array(), array('context' => 'bibdk_custom_search:error')), 'error');
  }
}

/** Check if advanced searchsettings have been activated in previous search
 *
 * @return bool
 */
function _bibdk_custom_search_is_advanced_search_expanded($get) {

  $query = isset($get['qe']) ? $get['qe'] : array();

  // one of the year.op options are always selected
  if ( isset($query['year.op']) ) {
    unset($query['year.op']);
  }

  // specialized search pages are only toggled visible if one of the elements are used
  // not including the delimiter
  if ( isset($query['delimiter']) ) {
    unset($query['delimiter']);
  }

  if ( count($query) > 0 ) {
    return TRUE;
  }

  if (
    ( isset($get['q']) && $get['q'] == 'bibdk_frontpage' ) ||
    ( isset($get['page_id']) && $get['page_id'] == 'bibdk_frontpage' )
  ) {
    return FALSE;
  }

  return TRUE;

}

/**
 * Strips a string for spaces and lowersaces it
 *
 * @param string $string
 * @return string
 */
function _bibdk_custom_search_trim_string($string) {
  return strtolower(strtr($string, array(
    ' ' => '',
    '-' => '',
    'æ' => 'ae',
    'ø' => 'oe',
    'å' => 'aa',
  )));
}

/**
 * Strips a string for spaces, æøå and lowercawes it
 *
 * @param string $string
 * @return string
 */
function _bibdk_custom_search_machine_readable($string) {
  return strtolower(preg_replace(array(
    '@[æøå]+@',
    '@[^a-z0-9_]+@'
  ), array(
    'a',
    '_'
  ), $string));
}

/**
 * Renders a form button for each page in pages array
 *
 * @param string $req
 * @return array
 */
function _bibdk_custom_search_get_searchpage_buttons($req) {
  $pages = _bibdk_custom_search_get_pages_db();

  if (!$pages) {
    return null;
  }
  $searchpages['#type'] = 'markup';
  $searchpages['#prefix'] = '<nav id="search-tabs" class="clearfix"><ul class="nav--horizontal">';
  $searchpages['#suffix'] = '</ul></nav>';

  foreach ($pages as $page) {
    $class = ($page['href'] == $req) ? 'active' : '';
    $searchpages[$page['title']] = array(
      '#type' => 'button',
      '#value' => $page['title'],
      '#executes_submit_callback' => TRUE,
      '#submit' => array('bibdk_custom_search_new_searchpage_picked'),
      '#attributes' => array(
        'class' => array(
          $class
        ),
        'data-type' => array(
          $page['href'],
        ),
      ),
      '#dest' => $page['href'],
      '#prefix' => '<li>',
      '#suffix' => '</li>',
    );
  }
  return $searchpages;
}

function bibdk_custom_searchpage_ajax_callback() {
  $type = $_GET['type'];
  $_GET['q'] = $type;

  $bodyClass = 'page-' . strtr($type, array(
      '/' => '-',
      '_' => '-',
    ));

  $form = drupal_render(drupal_get_form('search_block_form'));

  $label_type = t('label_' . str_replace('/', '_', $type), array(), array('context' => 'bibdk_custom_search'));

  drupal_json_output(array(
    'bodyclass' => $bodyClass,
    'form' => $form,
    'request' => $type,
    'label_type' => $label_type
  ));

  exit();
}

/**
 * Submit handler for search page selection.
 * When a searchpage is selected for the first time a form submit will happen
 *
 * @param $form
 * @param $form_state
 */

function bibdk_custom_search_new_searchpage_picked($form, $form_state) {
  $dest = $form_state['clicked_button']['#dest'];
  drupal_goto($dest);
}


/**
 * Implements hook_theme().
 */
function bibdk_custom_search_theme() {
  $path = drupal_get_path('module', 'bibdk_custom_search') . '/theme';
  $bibdk_custom_search_theme_array = array(
    'bibdk_custom_search-sort-pages-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-sort-pages-form',
    ),
    'bibdk_custom_search-edit-page-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-edit-page-form',
    ),
    'bibdk_custom_search-edit-page-elements-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-sort-region-form',
    ),
    'bibdk_custom_search-list-elements-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-sort-elements-form',
    ),
    'bibdk_custom_search-edit-element-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-edit-element-form',
    ),
    'bibdk_custom_search-edit-element-values-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-edit-element-values-form',
    ),
    'bibdk_custom_search-list-values-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-sort-values-form',
    ),
    'bibdk_custom_search-edit-value-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-edit-value-form',
    ),
    'bibdk_custom_search-list-options-form' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-sort-options-form',
    ),
    'bibdk_search_element' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk_custom_search-search-element-form',
    ),
    'bibdk_custom_search_menu' => array(
      'path' => $path,
      'variables' => array('pages' => array()),
      'template' => 'bibdk-custom-search-menu',
    ),
    'bibdk_custom_advanced_search_menu' => array(
      'render element' => 'form',
      'path' => $path,
      'template' => 'bibdk-custom-advanced-search-menu',
    ),
  );

  return $bibdk_custom_search_theme_array;
}


/**
 * Translate boolean operators used in form values.
 */
function _translate_boolean($value) {
  global $language;

  $booleanEnglish = array(
    ' AND ',
    ' OR ',
    ' NOT '
  );

  $booleanDanish = array(
    ' OG ',
    ' ELLER ',
    ' IKKE'
  );

  switch ($language->language) {
    CASE 'en-gb':
      $replaceFrom = $booleanDanish;
      $replaceTo = $booleanEnglish;
      break;
    DEFAULT:
      $replaceFrom = $booleanEnglish;
      $replaceTo = $booleanDanish;
      break;
  }

  return str_ireplace($replaceFrom, $replaceTo, $value);

}


/** Wrapper for ting_openformat_get_cql_commando
 * see ting_openformat.module
 *
 * @param $cql
 * @return string
 */
function _bibdk_custom_search_get_cql($cql) {
  return function_exists('ting_openformat_get_cql_commando') ? ting_openformat_get_cql_commando($cql) : ' ' . $cql . ' ';
}


/**
 * Implements hook_block_info().
 */
function bibdk_custom_search_block_info() {
  $blocks['bibdk-search-menu'] = array(
    'info' => t('Bibliotek.dk search menu'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );
  return $blocks;
}


/**
 * Implements hook_block_view().
 */
function bibdk_custom_search_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'bibdk-search-menu':
      $block['subject'] = t('Bibliotek.dk search menu');
      $block['content'] = theme('bibdk_custom_search_menu', array('pages' => _bibdk_custom_search_get_pages_db()));
      break;
  }
  return $block;
}

/**
 * Extract title, description and helptext from render-array, and set them as individual variables to be set in the template
 *
 * @param $vars
 */
function bibdk_custom_search_preprocess_bibdk_search_element(&$vars) {
  $vars['title'] = isset($vars['form']['#title_text']) ? $vars['form']['#title_text'] : "";
  $vars['help'] = isset($vars['form']['#help_text']) ? $vars['form']['#help_text'] : "";
  $vars['description'] = isset($vars['form']['#description_text']) ? $vars['form']['#description_text'] : "";
}

/**
 * Translates a string and appends the given context.
 * The main purpose of this function is to ensure that any changes made to
 * bibdk_custom_search pages is written to db immediately and thereby availabel
 * for translation with clearing cache.
 *
 * @param string $string
 * @param string $context
 * @return null|string
 */
function bibdk_custom_search_translate_update($string, $context) {
  return t($string, array(), array('context' => "bibdk_custom_search:$context"));
}


/**
 * Translates a string and appends the given context.
 *
 * @param string $string
 * @param string $context
 * @return null|string
 */
function bibdk_custom_search_translate($string, $context) {
  return t($string, array(), array('context' => "bibdk_custom_search:$context"));
}

